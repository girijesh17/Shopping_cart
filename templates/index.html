<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Enhanced Shopping Cart System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <div class="container my-5">
        <h1 class="text-center mb-4 text-primary">üõçÔ∏è POS Billing System (Enhanced)</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="row">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else ('success' if category == 'success' else 'info') }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        
        <div class="row">
            <div class="col-md-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Customer Details</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('index') }}">
                            <div class="mb-3">
                                <label for="customer_name" class="form-label">Name</label>
                                <input type="text" class="form-control" id="customer_name" name="customer_name" value="{{ session.get('customer_name', '') }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="customer_phone" class="form-label">Phone</label>
                                <input type="text" class="form-control" id="customer_phone" name="customer_phone" value="{{ session.get('customer_phone', '') }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="customer_id" class="form-label">ID / Membership No.</label>
                                <input type="text" class="form-control" id="customer_id" name="customer_id" value="{{ session.get('customer_id', '') }}">
                            </div>
                            <button type="submit" class="btn btn-success w-100">Update Customer</button>
                        </form>
                    </div>
                </div>
                
                <div class="card shadow-sm mb-4">
                    <div class="card-body text-center">
                        <h4 class="card-title">Cart Subtotal</h4>
                        <p class="display-6 fw-bold">‚Çπ {{ "{:,.2f}".format(subtotal) }}</p>
                        <a href="{{ url_for('print_bill') }}" class="btn btn-lg btn-warning w-100 mb-2">Generate Final Bill üßæ</a>
                        <a href="{{ url_for('clear_cart') }}" class="btn btn-sm btn-outline-danger w-100">Clear Cart & Customer</a>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Available Products</h5>
                    </div>
                    <div class="card-body">
                        
                        <div class="accordion" id="productsAccordion">
                            {% for category, item_list in items.items() %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading{{ loop.index }}">
                                    <button class="accordion-button {% if loop.index != 1 %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="{% if loop.index == 1 %}true{% else %}false{% endif %}" aria-controls="collapse{{ loop.index }}">
                                        {{ category }} ({{ item_list|length }} Items)
                                    </button>
                                </h2>
                                <div id="collapse{{ loop.index }}" class="accordion-collapse collapse {% if loop.index == 1 %}show{% endif %}" aria-labelledby="heading{{ loop.index }}" data-bs-parent="#productsAccordion">
                                    <div class="accordion-body">
                                        <div class="row row-cols-md-3 g-3">
                                            {% for name, details in item_list.items() %}
                                            <div class="col">
                                                <div class="p-2 border rounded bg-light">
                                                    <p class="mb-1 fw-bold">{{ name }}</p>
                                                    <p class="mb-1 text-success">‚Çπ {{ "{:,.2f}".format(details['price']) }}</p>
                                                    <p class="mb-1 text-muted small">Stock: {{ details['stock'] }}</p>
                                                    
                                                    <form method="POST" action="{{ url_for('add_item') }}" class="mt-2 d-flex">
                                                        <input type="hidden" name="item" value="{{ name }}">
                                                        <input type="number" name="quantity" value="1" min="1" max="{{ details['stock'] }}" class="form-control form-control-sm me-2" style="width: 70px;" required>
                                                        <button type="submit" class="btn btn-primary btn-sm flex-grow-1">Add</button>
                                                    </form>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <hr class="my-5">

        <h2 class="mb-3 text-center">üõí Current Cart ({{ cart|length }} Items)</h2>
        {% if cart %}
            <div class="table-responsive">
                <table class="table table-bordered table-striped align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Item Name</th>
                            <th>Category</th>
                            <th>Price (‚Çπ)</th>
                            <th>Quantity</th>
                            <th>Sub Total (‚Çπ)</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in cart %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ item.name }}</td>
                            <td><span class="badge bg-secondary">{{ item.category }}</span></td>
                            <td>{{ "{:,.2f}".format(item.price) }}</td>
                            <td>
                                <form method="POST" action="{{ url_for('update_item', item_id=item.id) }}" class="d-flex">
                                    <input type="number" name="quantity" value="{{ item.quantity }}" min="1" max="{{ items[item.category][item.name].stock }}" class="form-control form-control-sm me-2" style="width: 80px;" required>
                                    <button type="submit" class="btn btn-sm btn-outline-info">Update</button>
                                </form>
                            </td>
                            <td><span class="fw-bold">‚Çπ {{ "{:,.2f}".format(item.price * item.quantity) }}</span></td>
                            <td>
                                <a href="{{ url_for('delete_item', item_id=item.id) }}" class="btn btn-sm btn-danger">Delete</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="table-primary">
                            <td colspan="5" class="text-end fw-bold">GRAND SUBTOTAL (Before Tax/Discount):</td>
                            <td colspan="2" class="fw-bold fs-5">‚Çπ {{ "{:,.2f}".format(subtotal) }}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        {% else %}
            <div class="alert alert-warning text-center" role="alert">
                Your cart is empty. Please add items from the list above.
            </div>
        {% endif %}
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>